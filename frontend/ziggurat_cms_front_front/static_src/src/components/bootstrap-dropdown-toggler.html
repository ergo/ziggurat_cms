<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/flattened-nodes-observer.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/debounce.html">

<dom-module id="bootstrap-dropdown-toggler">
    <template>
        <slot></slot>
    </template>
    <script>

        class BootstrapDropdownToggler extends Polymer.GestureEventListeners(Polymer.Element) {
            static get is() {
                return "bootstrap-dropdown-toggler";
            }

            static get properties() {
                return {
                    toggled: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    },
                    clsName: {
                        type: String,
                        value: 'show'
                    },
                    targetSelector: String,
                }
            }

            constructor() {
                super();
                this._boundHoverListener = this.hoverHandler.bind(this);
            }

            connectedCallback() {
                super.connectedCallback();
                window.addEventListener('mousemove', this._boundHoverListener);
                Polymer.Gestures.addListener(this, 'tap', this.toggleCls.bind(this));
            }

            disconnectedCallback() {
                super.disconnectedCallback();
                window.addEventListener('mousemove', this._boundHoverListener);
                Polymer.Gestures.removeListener(this, 'tap', this.toggleCls.bind(this));
            }

            hoverHandler(event) {
                this._debouncer = Polymer.Debouncer.debounce(this._debouncer,
                    Polymer.Async.timeOut.after(50),
                    () => {
                        var path = event.path || event.composedPath();
                        for (var i = 0; i < path.length; i++) {
                            var target = path[i];
                            if (!target.tagName) {
                                continue
                            }
                            if (this.contains(target)) {
                                this.toggled = true;
                                break;
                            } else {
                                this.toggled = false;
                            }
                        }
                        this.setCls();

                    });

            }

            toggleCls() {
                this.toggled = !this.toggled;
                this.setCls();
            }

            setCls(event) {
                let effectiveChildren =
                    Polymer.FlattenedNodesObserver.getFlattenedNodes(this).filter(n => n.nodeType === Node.ELEMENT_NODE);

                console.log(effectiveChildren);
                if (effectiveChildren.length > 0) {
                    let node = effectiveChildren[0].querySelector(this.targetSelector);
                    if (node) {
                        node.classList.toggle(this.clsName, this.toggled);
                    }
                }
            }
        }

        customElements.define(BootstrapDropdownToggler.is, BootstrapDropdownToggler);

    </script>
</dom-module>
