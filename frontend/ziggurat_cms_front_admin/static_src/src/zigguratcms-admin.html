<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<script src="../bower_components/js-cookie/src/js.cookie.js"></script>
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/polymer-ui-router/uirouter-mixin.html">
<link rel="import" href="../bower_components/polymer-ui-router/uirouter-router.html">
<link rel="import" href="../bower_components/polymer-ui-router/uirouter-sref.html">
<link rel="import" href="../bower_components/polymer-ui-router/uirouter-sref-active.html">
<link rel="import" href="../bower_components/polymer-ui-router/uirouter-uiview.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="views/zigguratcms-page404.html">
<link rel="import" href="views/zigguratcms-resources-view.html">
<link rel="import" href="views/zigguratcms-settings-view.html">
<link rel="import" href="views/zigguratcms-users-view.html">
<link rel="import" href="views/zigguratcms-groups-view.html">
<link rel="import" href="views/zigguratcms-index-view.html">
<link rel="import" href="components/user-provider.html">
<link rel="import" href="components/loader-overlay.html">
<link rel="import" href="components/app-debug.html">
<link rel="import" href="redux-store.html">

<dom-module id="zigguratcms-admin">
    <template>

        <uirouter-router id="ui-router" states="[[routerStates]]" auto-start></uirouter-router>

        <loader-overlay opened="[[overlayOpened]]" id="loader-overlay" with-backdrop></loader-overlay>
        <user-provider current-user="{{currentUser}}" user-permissions="{{userPermissions}}"
                       top-level-resource-permissions="{{topLevelResourcePermissions}}"
                       access-to-admin="{{accessToAdmin}}"></user-provider>

        <paper-toast id="default-toast" duration="0" text="[[toastMessage]]" opened="[[toastOpened]]">
            <paper-button on-tap="toastClose" raised>[[localize('Close')]]</paper-button>
        </paper-toast>

        <template is="dom-if" if="[[accessToAdmin]]">

            <app-drawer-layout>
                <app-drawer slot="drawer">
                    <div class="drawer-list">
                        <uirouter-sref-active>
                            <uirouter-sref state="index">
                            <span><iron-icon icon="icons:home"></iron-icon>
                                [[localize('Index page')]]</span>
                            </uirouter-sref>
                        </uirouter-sref-active>

                        <uirouter-sref-active>
                            <uirouter-sref state="resources.list">
                            <span><iron-icon icon="icons:add-circle"></iron-icon>
                                [[localize('Resources')]]</span>
                            </uirouter-sref>
                        </uirouter-sref-active>

                        <uirouter-sref-active>
                            <uirouter-sref state="users.list">
                            <span><iron-icon icon="social:person"></iron-icon>
                                [[localize('Users')]]</span>
                            </uirouter-sref>
                        </uirouter-sref-active>
                        <uirouter-sref-active>
                            <uirouter-sref state="groups">
                            <span><iron-icon icon="social:group"></iron-icon>
                                [[localize('Groups')]]</span>
                            </uirouter-sref>
                        </uirouter-sref-active>
                        <uirouter-sref-active>
                            <uirouter-sref state="settings">
                            <span><iron-icon icon="icons:settings"></iron-icon>
                                [[localize('Settings')]]</span>
                            </uirouter-sref>
                        </uirouter-sref-active>

                        <a name="sign-out" href="/sign_out">
                            <iron-icon icon="icons:exit-to-app"></iron-icon>
                            [[localize('Sign Out')]]</a>
                    </div>
                </app-drawer>
                <app-header-layout>
                    <app-header slot="header">
                        <app-toolbar>
                            <paper-icon-button icon="icons:menu" drawer-toggle></paper-icon-button>
                            <div main-title>{{localize('Administration Panel')}}</div>
                        </app-toolbar>
                    </app-header>

                    <uirouter-uiview id="main-uirouter-view"></uirouter-uiview>

                </app-header-layout>
            </app-drawer-layout>


        </template>

    </template>

    <script>
        class ZigguratCMSAdmin extends UiRouterMixin(ZigguratAdminBasicMixin(Polymer.GestureEventListeners(
            Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element)))) {
            static get is() {
                return "zigguratcms-admin";
            }

            static get properties() {
                return {
                    message: {
                        type: String,
                        statePath: 'message' // ...and let the magic begin!
                    },

                    routerStates: {
                        type: Object,
                        value: function () {
                            return [
                                {name: "index", url: "/index", component: 'zigguratcms-index-view'},
                                {
                                    name: "resources",
                                    url: "/o/resources",
                                    abstract: true,
                                    component: 'zigguratcms-resources-view'
                                },
                                {
                                    name: "resources.list",
                                    url: "/list?:objectId",
                                    component: 'zigguratcms-resource-list-view'
                                },
                                {
                                    name: "resources.create",
                                    url: "/:objectId/create",
                                    component: 'zigguratcms-resource-create-node-view'
                                },
                                {
                                    name: "resources.edit",
                                    url: "/:objectId/edit/type/:type",
                                    component: 'zigguratcms-resource-edit-node-view'
                                },
                                {name: "users", url: "/o/users", abstract: true, component: 'zigguratcms-users-view'},
                                {name: "users.list", url: "/list", component: 'user-list'},
                                {name: "users.edit", url: "/:userId/edit", component: 'zigguratcms-users-edit-view'},
                                {name: "groups", url: "/o/groups", component: 'zigguratcms-groups-view'},
                                {name: "settings", url: "/settings", component: 'zigguratcms-settings-view'},
                                {name: "profile", url: "/profile", component: 'zigguratcms-profile-view'}
                            ]
                        }
                    },
                    section: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_sectionChanged'
                    },
                    accessToAdmin: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    currentUser: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    userPermissions: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    topLevelResourcePermissions: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    overlayCounter: {
                        type: Number,
                        value: 0
                    },
                    overlayOpened: {
                        type: Boolean,
                        computed: 'computeOverlayOpened(overlayCounter)'
                    },
                    toastMessage: String,
                    toastOpened: Boolean,
                    useKeyIfMissing: {
                        value: true,
                        type: Boolean
                    },
                    language: {
                        value: function () {
                            return window.TRANSLATION_LANGUAGE || 'en'
                        },
                        type: String
                    },
                    resources: {
                        type: Object,
                        value: function () {
                            return window.TRANSLATIONS || {en: {}}
                        }
                    }
                }
            }

            computeOverlayOpened() {
                console.log('overlay counter', this.overlayCounter)
                if (this.overlayCounter > 0) {
                    return true;
                }
                return false;
            }

            handleOverlayAjaxCounter(event) {
                if (event.type == 'overlay-ajax-started') {
                    this.overlayCounter += 1
                } else if (this.overlayCounter > 0) {
                    this.overlayCounter -= 1;
                }
            }

            toastClose() {
                this.$['default-toast'].close();
            }

            handleToastMessage(event) {
                console.log('handleToastMessage', event);
                this.toastMessage = event.detail.message;
                this.$['default-toast'].open();
            }

            handleFlashMessage(event) {
                console.log('handleFlashMessage', event.detail);
                if (event.detail.messages.length > 0) {
                    var message = event.detail.messages[event.detail.messages.length - 1].msg;
                    this.dispatchEvent(new CustomEvent('toast-message', {detail: {message: message}}));
                }
            }

            handleIronAjaxError(event) {
                console.log('handleIronAjaxError', event);
                if (event.detail.request.xhr) {
                    let flashMessages = event.detail.request.xhr.getResponseHeader('x-flash-messages');
                    if (flashMessages) {
                        let messages = JSON.parse(flashMessages);
                        // no flash may mean we got a 500 response
                        if (messages.length == 0) {
                            messages = [
                                {msg: this.localize('HTTP response error'), level: 'danger'}
                            ];
                        }
                        this.dispatchEvent(new CustomEvent('flash-message', {detail: {messages: messages}}));
                    }
                }
            }

            handleIronAjaxResponse(event) {
                console.log('handleIronAjaxResponse', event.detail.response);
                if (event.detail.xhr) {
                    let flashMessages = event.detail.xhr.getResponseHeader('x-flash-messages');
                    if (flashMessages) {
                        flashMessages = JSON.parse(flashMessages);
                        this.dispatchEvent(new CustomEvent('flash-message', {detail: {messages: flashMessages}}));
                    }
                }
            }

            handleRedirectUrl(event) {
                console.log('event.detail', event.detail);
                let url = this.uiRouter.stateService.go(event.detail.state, event.detail.params || {}, event.detail.options || {});
            }

            constructor() {
                super();
            }

            connectedCallback() {
                super.connectedCallback();
                this.addEventListener('overlay-ajax-started', this.handleOverlayAjaxCounter);
                this.addEventListener('overlay-ajax-stopped', this.handleOverlayAjaxCounter);
                this.addEventListener('toast-message', this.handleToastMessage);
                this.addEventListener('flash-message', this.handleFlashMessage);
                this.addEventListener('iron-ajax-error', this.handleIronAjaxError);
                this.addEventListener('iron-ajax-response', this.handleIronAjaxResponse);
                this.addEventListener('redirect-url', this.handleRedirectUrl);
            }

            disconnectedCallback() {
                super.disconnectedCallback();
                this.removeEventListener('overlay-ajax-started', this.handleOverlayAjaxCounter);
                this.removeEventListener('overlay-ajax-stopped', this.handleOverlayAjaxCounter);
                this.removeEventListener('toast-message', this.handleToastMessage);
                this.removeEventListener('flash-message', this.handleFlashMessage);
                this.removeEventListener('iron-ajax-error', this.handleIronAjaxError);
                this.removeEventListener('iron-ajax-response', this.handleIronAjaxResponse);
                this.removeEventListener('redirect-url', this.handleRedirectUrl);
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }
        }

        customElements.define(ZigguratCMSAdmin.is, ZigguratCMSAdmin);


    </script>
</dom-module>
